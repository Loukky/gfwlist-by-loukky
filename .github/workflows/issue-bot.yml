name: Issue Auto Management

on:
  issues:
    types: [opened, closed]

jobs:
  handle-issues:
    runs-on: ubuntu-latest

    steps:
      - name: Auto manage issue lifecycle
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const issueNumber = issue.number;

            // === 1️⃣ 新建 Issue ===
            if (context.payload.action === "opened") {
              console.log(`New issue #${issueNumber} detected.`);

              // 自动回复
              const message = `
👋 感谢你提交 Issue！

请在反馈前确认以下几点：
- ✅ 该域名或网站已在多个网络环境下（例如移动/联通/电信、境外网络）测试，确实被 GFW 屏蔽；
- 🧩 如果只是暂时性访问异常，请先多次测试确认；
- 🌐 建议附上 dig/ping/mtr 等测试截图或结果，以便我们复现问题。

---

**English:**
Hi! Thanks for submitting an issue.

Before reporting, please make sure:
- ✅ The domain or site has been tested from multiple networks (e.g., China Mobile/Unicom/Telecom and abroad) and is truly blocked by GFW;
- 🧩 If it’s only a temporary connection failure, please double-check it several times;
- 🌐 It’s recommended to attach dig/ping/mtr results or screenshots for reference.

Thank you for helping us keep the GFWList accurate! 🙏
`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: message
              });

              // 添加 unconfirmed 标签
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ["unconfirmed"]
              });
            }

            // === 2️⃣ Issue 被关闭 ===
            else if (context.payload.action === "closed") {
              console.log(`Issue #${issueNumber} closed.`);

              // 如果 issue 是被真正关闭（不是重新打开）
              if (!issue.state_reason || issue.state_reason !== "reopened") {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ["fixed"]
                });

                console.log(`Added 'fixed' label to issue #${issueNumber}.`);
              }
            }
