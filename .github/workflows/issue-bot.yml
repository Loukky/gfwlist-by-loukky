name: Issue Auto Management

on:
  issues:
    types: [opened, closed, reopened]

jobs:
  handle-issues:
    runs-on: ubuntu-latest

    steps:
      - name: Auto manage issue lifecycle
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const action = context.payload.action;
            const issueNumber = issue.number;

            // 新建 issue：回复并打 unconfirmed 标签
            if (action === "opened") {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                    body: [
                      "感谢你提交 Issue！",
                      "",
                      "请注意：",
                      "- 该域名或网站已在多个网络环境下测试不能打开，但是境外主机却能打开；",
                      "- 建议附上 dig/ping/mtr/curl 等测试截图或结果，方便我们复现问题；",
                      "- 建议反馈时提供：网址 + 现象 + 您的 ISP + 其他帮助提示或看法；",
                      "- 标题栏仅填写相关地址，不建议把所有内容都写在标题；",
                      "- 如果有补充内容，请在我们回复前编辑修改；已回复的 Issue，请留言告诉我们修改内容，以避免遗漏。",
                      "",
                      "---",
                      "",
                      "Hi! Thanks for submitting an issue.",
                      "",
                      "Please note:",
                      "- The domain or site has been tested from multiple networks and cannot be accessed in China, but is accessible from overseas;",
                      "- It’s recommended to attach dig/ping/mtr/curl results or screenshots for reference;",
                      "- When reporting, please provide: URL + symptom + your ISP + other helpful tips or comments;",
                      "- Only include the relevant address in the title; don’t try to put all information in the title;",
                      "- If you have additional information, edit it before we reply; for issues we have already replied to, leave a comment to notify us of changes to avoid missing updates.",
                      "",
                      "Thank you for helping us keep the list accurate!"
                    ].join("\n")

                    });

              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ["unconfirmed"]
                });
              } catch (e) {
                console.log("Add label error (ignored):", e.message || e);
              }
            }

            // 关闭 issue：移除 unconfirmed 标签并添加 fixed 标签
            else if (action === "closed") {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: "unconfirmed"
                });
              } catch (e) {
                console.log("Remove label (maybe not present):", e.message || e);
              }

              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ["fixed"]
                });
              } catch (e) {
                console.log("Add label error (ignored):", e.message || e);
              }
            }

            // 重新打开 issue：添加 reopen 标签
            else if (action === "reopened") {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: [
                "此 Issue 已重新开启，请确认该域名或网站是否仍被屏蔽。",
                "",
                "---",
                "",
                "This issue has been reopened. Please confirm if the domain or site is still blocked."
                ].join("\n")
              });

              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ["reopen"]
                });
              } catch (e) {
                console.log("Add label error (ignored):", e.message || e);
              }
              // 尝试移除 fixed 标签
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: "fixed"
                });
              } catch (e) {
                // 如果标签不存在会报 404，忽略
                console.log("Remove fixed label (maybe not present):", e.message || e);
              }
            }
