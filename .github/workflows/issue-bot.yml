name: Issue Auto Management

on:
  issues:
    types: [opened, closed, reopened]

jobs:
  handle-issues:
    runs-on: ubuntu-latest

    steps:
      - name: Auto manage issue lifecycle
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const action = context.payload.action;
            const issueNumber = issue.number;

            // æ–°å»º issueï¼šå›å¤å¹¶æ‰“ unconfirmed æ ‡ç­¾
            if (action === "opened") {
              const message = [
                "æ„Ÿè°¢ä½ æäº¤ Issueï¼",
                "",
                "è¯·åœ¨åé¦ˆå‰ç¡®è®¤ä»¥ä¸‹å‡ ç‚¹ï¼š",
                "- âœ… è¯¥åŸŸåæˆ–ç½‘ç«™å·²åœ¨å¤šä¸ªç½‘ç»œç¯å¢ƒä¸‹ï¼ˆä¾‹å¦‚ç§»åŠ¨/è”é€š/ç”µä¿¡ã€å¢ƒå¤–ç½‘ç»œï¼‰æµ‹è¯•ï¼Œç¡®å®è¢« GFW å±è”½ï¼›",
                "- ğŸ§© å¦‚æœåªæ˜¯æš‚æ—¶æ€§è®¿é—®å¼‚å¸¸ï¼Œè¯·å…ˆå¤šæ¬¡æµ‹è¯•ç¡®è®¤ï¼›",
                "- ğŸŒ å»ºè®®é™„ä¸Š dig/ping/mtr/curl ç­‰æµ‹è¯•æˆªå›¾æˆ–ç»“æœï¼Œä»¥ä¾¿æˆ‘ä»¬å¤ç°é—®é¢˜ã€‚",
                "",
                "---",
                "",
                "English:",
                "Hi! Thanks for submitting an issue.",
                "",
                "Before reporting, please make sure:",
                "- âœ… The domain or site has been tested from multiple networks (e.g., China Mobile/Unicom/Telecom and abroad) and is truly blocked by GFW;",
                "- ğŸ§© If itâ€™s only a temporary connection failure, please double-check it several times;",
                "- ğŸŒ Itâ€™s recommended to attach dig/ping/mtr/curl results or screenshots for reference.",
                "",
                "Thank you for helping us keep the GFWList accurate! ğŸ™"
              ].join("\n");

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: message
              });

              // æ·»åŠ  unconfirmed æ ‡ç­¾ï¼ˆå¦‚æœå·²æœ‰åˆ™å¿½ç•¥é”™è¯¯ï¼‰
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ["unconfirmed"]
                });
              } catch (e) {
                // å¿½ç•¥å·²å­˜åœ¨æ ‡ç­¾ç­‰é”™è¯¯
                console.log("Add label error (ignored):", e.message || e);
              }
            }

            // å…³é—­ issueï¼šæ·»åŠ  fixed æ ‡ç­¾
            else if (action === "closed") {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ["fixed"]
                });
              } catch (e) {
                console.log("Add label error (ignored):", e.message || e);
              }
            }

            // é‡æ–°æ‰“å¼€ issueï¼šç§»é™¤ fixed æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            else if (action === "reopened") {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: "fixed"
                });
              } catch (e) {
                // å¦‚æœæ ‡ç­¾ä¸å­˜åœ¨ä¼šæŠ¥ 404ï¼Œå¿½ç•¥
                console.log("Remove label (maybe not present):", e.message || e);
              }
            }
